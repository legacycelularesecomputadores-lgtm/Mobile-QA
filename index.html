<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PhoneDiag â€” DiagnÃ³stico de Hardware</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;700;800;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c10;
    --bg2: #0d1218;
    --bg3: #121820;
    --card: #0f1520;
    --border: #1e2d3d;
    --accent: #00e5a0;
    --accent2: #00b4ff;
    --warn: #ffaa00;
    --danger: #ff3b5c;
    --text: #e8f0fe;
    --muted: #5a7a9a;
    --pass: #00e5a0;
    --fail: #ff3b5c;
    --skip: #5a7a9a;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid BG */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,229,160,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,160,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* SCREENS */
  .screen { display: none; position: relative; z-index: 1; }
  .screen.active { display: flex; flex-direction: column; min-height: 100vh; }

  /* â”€â”€â”€ SPLASH â”€â”€â”€ */
  #splash {
    align-items: center;
    justify-content: center;
    padding: 40px 24px;
    text-align: center;
    gap: 0;
  }

  .logo-ring {
    width: 120px; height: 120px;
    border-radius: 50%;
    border: 2px solid var(--accent);
    display: flex; align-items: center; justify-content: center;
    position: relative;
    margin: 0 auto 32px;
    animation: ring-pulse 3s ease-in-out infinite;
    box-shadow: 0 0 40px rgba(0,229,160,0.2), inset 0 0 40px rgba(0,229,160,0.05);
  }
  .logo-ring::before {
    content: '';
    position: absolute;
    inset: 6px;
    border-radius: 50%;
    border: 1px solid rgba(0,229,160,0.3);
    animation: ring-pulse 3s ease-in-out infinite 0.5s;
  }
  .logo-ring svg { width: 48px; height: 48px; }

  @keyframes ring-pulse {
    0%, 100% { box-shadow: 0 0 40px rgba(0,229,160,0.2); }
    50% { box-shadow: 0 0 60px rgba(0,229,160,0.4), 0 0 120px rgba(0,229,160,0.1); }
  }

  .logo-title {
    font-family: var(--sans);
    font-size: 42px;
    font-weight: 900;
    letter-spacing: -2px;
    line-height: 1;
    margin-bottom: 6px;
  }
  .logo-title span { color: var(--accent); }

  .logo-sub {
    font-size: 11px;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 40px;
  }

  .splash-desc {
    max-width: 340px;
    margin: 0 auto 48px;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.7;
  }

  .test-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    max-width: 380px;
    margin: 0 auto 48px;
  }
  .test-preview-tag {
    font-size: 10px;
    letter-spacing: 1px;
    padding: 5px 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .btn-primary {
    background: var(--accent);
    color: var(--bg);
    font-family: var(--sans);
    font-weight: 800;
    font-size: 16px;
    letter-spacing: 1px;
    padding: 18px 48px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,229,160,0.4); }
  .btn-primary:active { transform: translateY(0); }

  .btn-secondary {
    background: transparent;
    color: var(--muted);
    font-family: var(--mono);
    font-size: 13px;
    padding: 12px 24px;
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-pass {
    background: rgba(0,229,160,0.15);
    color: var(--accent);
    border: 1px solid var(--accent);
    font-family: var(--sans);
    font-weight: 700;
    font-size: 15px;
    padding: 16px 32px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    flex: 1;
  }
  .btn-pass:hover { background: rgba(0,229,160,0.25); }

  .btn-fail {
    background: rgba(255,59,92,0.1);
    color: var(--fail);
    border: 1px solid var(--fail);
    font-family: var(--sans);
    font-weight: 700;
    font-size: 15px;
    padding: 16px 32px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    flex: 1;
  }
  .btn-fail:hover { background: rgba(255,59,92,0.2); }

  .btn-action {
    background: var(--accent2);
    color: var(--bg);
    font-family: var(--sans);
    font-weight: 700;
    font-size: 14px;
    padding: 14px 28px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 1px;
    width: 100%;
  }
  .btn-action:hover { filter: brightness(1.1); }
  .btn-action:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-warn {
    background: rgba(255,170,0,0.15);
    color: var(--warn);
    border: 1px solid var(--warn);
    font-family: var(--mono);
    font-size: 12px;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  /* â”€â”€â”€ TEST SCREEN â”€â”€â”€ */
  #testscreen { padding: 0; }

  .test-header {
    position: sticky;
    top: 0;
    background: rgba(8,12,16,0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    z-index: 10;
  }

  .test-header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .test-brand {
    font-family: var(--sans);
    font-weight: 900;
    font-size: 18px;
    color: var(--accent);
    letter-spacing: -1px;
  }

  .test-counter {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 2px;
  }

  .progress-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width 0.4s ease;
    border-radius: 2px;
  }

  .test-body {
    padding: 24px 20px;
    flex: 1;
  }

  .test-category {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--accent2);
    margin-bottom: 8px;
  }

  .test-name {
    font-family: var(--sans);
    font-size: 28px;
    font-weight: 900;
    letter-spacing: -1px;
    margin-bottom: 8px;
    line-height: 1.1;
  }

  .test-desc {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.7;
    margin-bottom: 24px;
  }

  .test-zone {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 20px;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    position: relative;
    overflow: hidden;
  }

  .test-zone-status {
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .status-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--muted);
    display: inline-block;
    margin-right: 6px;
  }
  .status-dot.active { background: var(--accent); animation: blink 1s infinite; }
  .status-dot.warn { background: var(--warn); }
  .status-dot.error { background: var(--fail); }

  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* camera preview */
  .cam-preview {
    width: 100%;
    max-height: 240px;
    border-radius: 4px;
    object-fit: cover;
    background: #000;
  }

  /* audio meter */
  .audio-meter {
    width: 100%;
    height: 60px;
    position: relative;
    display: flex;
    align-items: flex-end;
    gap: 3px;
  }
  .meter-bar {
    flex: 1;
    background: var(--accent);
    border-radius: 2px 2px 0 0;
    min-height: 3px;
    transition: height 0.08s;
    opacity: 0.8;
  }

  /* touch canvas */
  #touchCanvas {
    width: 100%;
    height: 220px;
    border-radius: 4px;
    cursor: crosshair;
    touch-action: none;
    background: var(--bg);
  }

  /* verdict buttons */
  .verdict-row {
    display: flex;
    gap: 12px;
    margin-top: 8px;
  }

  .skip-row {
    text-align: center;
    margin-top: 12px;
  }

  /* info chips */
  .info-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 14px;
    font-size: 12px;
    color: var(--text);
  }
  .info-chip-label { color: var(--muted); font-size: 10px; letter-spacing: 1px; }

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    width: 100%;
  }
  .info-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px;
  }
  .info-card-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .info-card-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
  }
  .info-card-unit { font-size: 11px; color: var(--muted); }

  /* big icon */
  .big-icon {
    font-size: 48px;
    line-height: 1;
    margin-bottom: 8px;
  }

  /* â”€â”€â”€ RESULTS SCREEN â”€â”€â”€ */
  #results {
    padding: 0;
  }

  .results-header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 40px 24px 32px;
    text-align: center;
  }

  .results-score {
    font-family: var(--sans);
    font-size: 80px;
    font-weight: 900;
    line-height: 1;
    letter-spacing: -4px;
    margin-bottom: 4px;
  }
  .results-score.great { color: var(--pass); }
  .results-score.ok { color: var(--warn); }
  .results-score.bad { color: var(--fail); }

  .results-label {
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
  }

  .results-summary {
    display: flex;
    gap: 20px;
    justify-content: center;
    font-size: 13px;
  }
  .results-summary span { display: flex; align-items: center; gap: 6px; }

  .results-list {
    padding: 24px 20px;
  }

  .result-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
  }
  .result-item:last-child { border-bottom: none; }

  .result-icon {
    width: 36px; height: 36px;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .result-icon.pass { background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.3); }
  .result-icon.fail { background: rgba(255,59,92,0.1); border: 1px solid rgba(255,59,92,0.3); }
  .result-icon.skip { background: rgba(90,122,154,0.1); border: 1px solid rgba(90,122,154,0.3); }
  .result-icon.warn { background: rgba(255,170,0,0.1); border: 1px solid rgba(255,170,0,0.3); }

  .result-info { flex: 1; }
  .result-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
  .result-detail { font-size: 11px; color: var(--muted); }

  .result-badge {
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 3px;
    font-weight: 700;
    flex-shrink: 0;
  }
  .result-badge.pass { background: rgba(0,229,160,0.15); color: var(--pass); }
  .result-badge.fail { background: rgba(255,59,92,0.15); color: var(--fail); }
  .result-badge.skip { background: rgba(90,122,154,0.15); color: var(--skip); }
  .result-badge.warn { background: rgba(255,170,0,0.15); color: var(--warn); }

  .results-actions {
    padding: 24px 20px 40px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .export-note {
    font-size: 11px;
    color: var(--muted);
    text-align: center;
  }

  /* toast */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--card);
    border: 1px solid var(--accent);
    color: var(--accent);
    font-size: 13px;
    padding: 12px 24px;
    border-radius: 4px;
    transition: transform 0.3s ease;
    z-index: 100;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* spinner */
  .spinner {
    width: 32px; height: 32px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* battery viz */
  .battery-viz {
    position: relative;
    width: 80px;
    height: 40px;
    border: 2px solid currentColor;
    border-radius: 6px;
  }
  .battery-viz::after {
    content: '';
    position: absolute;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 16px;
    background: currentColor;
    border-radius: 0 3px 3px 0;
  }
  .battery-fill {
    position: absolute;
    left: 2px; top: 2px; bottom: 2px;
    border-radius: 3px;
    transition: width 0.5s;
  }

  /* network signal bars */
  .signal-bars {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    height: 32px;
  }
  .signal-bar {
    width: 8px;
    border-radius: 2px;
    background: var(--border);
    transition: background 0.3s;
  }
  .signal-bar.active { background: var(--accent); }

  /* multitouch indicator */
  .touch-dot {
    position: absolute;
    width: 40px; height: 40px;
    border-radius: 50%;
    border: 2px solid var(--accent);
    background: rgba(0,229,160,0.15);
    transform: translate(-50%, -50%);
    pointer-events: none;
    animation: touch-pop 0.3s ease;
  }
  @keyframes touch-pop {
    from { transform: translate(-50%,-50%) scale(0.5); opacity: 0; }
    to { transform: translate(-50%,-50%) scale(1); opacity: 1; }
  }

  /* section heading for results */
  .results-section-title {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    padding: 16px 0 8px;
  }

  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(8,12,16,0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border-radius: 8px;
    z-index: 5;
    font-size: 12px;
    color: var(--muted);
  }

  .device-info-bar {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 16px;
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 16px;
    line-height: 1.8;
  }

  .waveform-canvas {
    width: 100%;
    height: 80px;
    border-radius: 4px;
    background: var(--bg);
  }

  .cam-list {
    display: flex;
    gap: 8px;
    width: 100%;
    flex-wrap: wrap;
  }
  .cam-chip {
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 4px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg3);
  }
  .cam-chip.active {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(0,180,255,0.1);
  }

  .fingerprint-zone {
    width: 100px; height: 100px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }
  .fingerprint-zone.scanning {
    border-color: var(--accent);
    box-shadow: 0 0 30px rgba(0,229,160,0.3);
    animation: ring-pulse 1s infinite;
  }
  .fingerprint-zone.success {
    border-color: var(--pass);
    box-shadow: 0 0 30px rgba(0,229,160,0.5);
  }
  .fingerprint-zone.error-fp {
    border-color: var(--fail);
  }

  .torch-zone {
    width: 100px; height: 100px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .torch-zone.on {
    border-color: var(--warn);
    box-shadow: 0 0 40px rgba(255,170,0,0.5);
    background: rgba(255,170,0,0.05);
  }

  @media (max-width: 360px) {
    .test-name { font-size: 24px; }
    .logo-title { font-size: 36px; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPLASH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="splash" class="screen active">
  <div class="logo-ring">
    <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="14" y="4" width="20" height="40" rx="4" stroke="#00e5a0" stroke-width="2"/>
      <circle cx="24" cy="39" r="2" fill="#00e5a0"/>
      <line x1="18" y1="10" x2="30" y2="10" stroke="#00e5a0" stroke-width="2" stroke-linecap="round"/>
      <circle cx="24" cy="22" r="5" stroke="#00e5a0" stroke-width="1.5"/>
      <path d="M19 28 Q24 24 29 28" stroke="#00e5a0" stroke-width="1.5" fill="none" stroke-linecap="round"/>
    </svg>
  </div>

  <div class="logo-title">Phone<span>Diag</span></div>
  <div class="logo-sub">Hardware Diagnostic Suite</div>

  <p class="splash-desc">
    Testa todos os componentes do seu smartphone diretamente pelo browser, sem instalar nada.
  </p>

  <div class="test-preview">
    <span class="test-preview-tag">ğŸ“· CÃ¢meras</span>
    <span class="test-preview-tag">ğŸ¤ Microfones</span>
    <span class="test-preview-tag">ğŸ”Š Alto-falantes</span>
    <span class="test-preview-tag">ğŸ‘† Touch</span>
    <span class="test-preview-tag">ğŸ”µ Bluetooth</span>
    <span class="test-preview-tag">ğŸ“¶ Wi-Fi/SIM</span>
    <span class="test-preview-tag">ğŸ”¦ Flash</span>
    <span class="test-preview-tag">ğŸ”‹ Bateria</span>
    <span class="test-preview-tag">ğŸ” Biometria</span>
    <span class="test-preview-tag">ğŸŒ¡ï¸ Temperatura CPU</span>
  </div>

  <button class="btn-primary" onclick="startDiag()">Iniciar DiagnÃ³stico</button>
  <br><br>
  <p style="font-size:11px;color:var(--muted);max-width:300px;text-align:center;line-height:1.6">
    O site solicitarÃ¡ permissÃµes de cÃ¢mera, microfone e Bluetooth conforme necessÃ¡rio. Nenhum dado Ã© enviado a servidores.
  </p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TEST SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="testscreen" class="screen">
  <div class="test-header">
    <div class="test-header-top">
      <div class="test-brand">PhoneDiag</div>
      <div class="test-counter" id="testCounter">01 / 12</div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>

  <div class="test-body" id="testBody">
    <!-- Injected by JS -->
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="results" class="screen">
  <div class="results-header">
    <div class="results-score" id="scoreDisplay">0%</div>
    <div class="results-label">DiagnÃ³stico ConcluÃ­do</div>
    <div class="results-summary">
      <span><span class="status-dot" style="background:var(--pass)"></span><span id="passCount">0</span> OK</span>
      <span><span class="status-dot" style="background:var(--fail)"></span><span id="failCount">0</span> Falhou</span>
      <span><span class="status-dot" style="background:var(--skip)"></span><span id="skipCount">0</span> Pulado</span>
    </div>
  </div>

  <div class="results-list" id="resultsList"></div>

  <div class="results-actions">
    <button class="btn-primary" onclick="exportReport()">Exportar RelatÃ³rio</button>
    <button class="btn-secondary" onclick="restartDiag()">Novo DiagnÃ³stico</button>
    <p class="export-note">RelatÃ³rio salvo como arquivo .txt no seu dispositivo</p>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const results = {};
let currentTestIdx = 0;
let activeStream = null;
let audioCtx = null;
let micAnalyser = null;
let micAnimFrame = null;
let touchPoints = 0;
let maxTouchPoints = 0;
let touchDrawActive = false;
let torchActive = false;
let torchTrack = null;
let pressureObserver = null;

// Device info collected during tests
const deviceInfo = {
  userAgent: navigator.userAgent,
  cameras: [],
  microphones: [],
  platform: navigator.platform || 'unknown'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TESTS = [
  { id: 'speaker_main',    label: 'Alto-falante Principal', category: 'Ãudio',       emoji: 'ğŸ”Š', fn: testSpeakerMain   },
  { id: 'speaker_ear',     label: 'Alto-falante Auricular', category: 'Ãudio',       emoji: 'ğŸ“', fn: testSpeakerEar    },
  { id: 'cameras',         label: 'CÃ¢meras',               category: 'Visual',      emoji: 'ğŸ“·', fn: testCameras       },
  { id: 'microphones',     label: 'Microfones',            category: 'Ãudio',       emoji: 'ğŸ¤', fn: testMicrophones   },
  { id: 'touch',           label: 'Tela Touch',            category: 'Interface',   emoji: 'ğŸ‘†', fn: testTouch         },
  { id: 'network',         label: 'Sinal de Rede / SIM',   category: 'Conectividade',emoji: 'ğŸ“¶', fn: testNetwork       },
  { id: 'wifi',            label: 'Wi-Fi',                 category: 'Conectividade',emoji: 'ğŸ“¡', fn: testWifi          },
  { id: 'bluetooth',       label: 'Bluetooth',             category: 'Conectividade',emoji: 'ğŸ”µ', fn: testBluetooth     },
  { id: 'flash',           label: 'Flash / Lanterna',      category: 'Hardware',    emoji: 'ğŸ”¦', fn: testFlash         },
  { id: 'fingerprint',     label: 'ImpressÃ£o Digital',     category: 'SeguranÃ§a',   emoji: 'ğŸ”', fn: testFingerprint   },
  { id: 'battery',         label: 'Bateria & Carregamento',category: 'Hardware',    emoji: 'ğŸ”‹', fn: testBattery       },
  { id: 'thermal',         label: 'Temperatura / CPU',     category: 'Hardware',    emoji: 'ğŸŒ¡ï¸', fn: testThermal       },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

function startDiag() {
  currentTestIdx = 0;
  Object.keys(results).forEach(k => delete results[k]);
  showScreen('testscreen');
  loadTest(0);
}

function restartDiag() {
  stopStream();
  stopMic();
  startDiag();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST RUNNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTest(idx) {
  stopStream();
  stopMic();
  if (torchActive) turnOffTorch();
  if (pressureObserver) { try { pressureObserver.unobserve('cpu'); } catch(e){} pressureObserver = null; }

  if (idx >= TESTS.length) {
    showResults();
    return;
  }

  currentTestIdx = idx;
  const test = TESTS[idx];
  const pct = Math.round((idx / TESTS.length) * 100);

  document.getElementById('testCounter').textContent =
    String(idx + 1).padStart(2,'0') + ' / ' + String(TESTS.length).padStart(2,'0');
  document.getElementById('progressFill').style.width = pct + '%';

  const body = document.getElementById('testBody');
  body.innerHTML = `
    <div class="test-category">${test.category}</div>
    <div class="test-name">${test.label}</div>
    <div class="test-desc" id="testDesc">Aguardando...</div>
    <div class="test-zone" id="testZone">
      <div class="spinner"></div>
    </div>
    <div id="verdictArea"></div>
    <div class="skip-row">
      <button class="btn-warn" onclick="skipTest()">Pular este teste</button>
    </div>
  `;

  // Run
  try {
    test.fn();
  } catch(e) {
    setDesc('Erro ao iniciar: ' + e.message);
    setZone(`<p style="color:var(--fail);font-size:13px">âš ï¸ ${e.message}</p>`);
    showVerdict();
  }
}

function setDesc(html) {
  const el = document.getElementById('testDesc');
  if (el) el.innerHTML = html;
}

function setZone(html) {
  const el = document.getElementById('testZone');
  if (el) el.innerHTML = html;
}

function showVerdict(customHTML) {
  const el = document.getElementById('verdictArea');
  if (!el) return;
  el.innerHTML = customHTML || `
    <div class="verdict-row">
      <button class="btn-pass" onclick="recordResult('pass')">âœ… Funcionou</button>
      <button class="btn-fail" onclick="recordResult('fail')">âŒ NÃ£o Funcionou</button>
    </div>
  `;
}

function recordResult(status, detail) {
  const test = TESTS[currentTestIdx];
  results[test.id] = { status, detail: detail || '', label: test.label, emoji: test.emoji, category: test.category };
  stopStream();
  stopMic();
  loadTest(currentTestIdx + 1);
}

function skipTest() {
  const test = TESTS[currentTestIdx];
  results[test.id] = { status: 'skip', detail: 'Pulado pelo usuÃ¡rio', label: test.label, emoji: test.emoji, category: test.category };
  stopStream();
  stopMic();
  if (torchActive) turnOffTorch();
  loadTest(currentTestIdx + 1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stopStream() {
  if (activeStream) {
    activeStream.getTracks().forEach(t => t.stop());
    activeStream = null;
  }
}

function stopMic() {
  if (micAnimFrame) { cancelAnimationFrame(micAnimFrame); micAnimFrame = null; }
  if (audioCtx) { try { audioCtx.close(); } catch(e){} audioCtx = null; }
  micAnalyser = null;
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

function getAudioCtx() {
  if (!audioCtx || audioCtx.state === 'closed') {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioCtx;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: SPEAKER MAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function testSpeakerMain() {
  setDesc('Vamos tocar um som pelo alto-falante principal. Coloque o celular em modo normal (nÃ£o no ouvido) e pressione Tocar.');
  setZone(`
    <div class="big-icon">ğŸ”Š</div>
    <button class="btn-action" id="playBtn" onclick="playSpeakerTest(false)">Tocar Som de Teste</button>
    <div id="playStatus" style="font-size:12px;color:var(--muted)">Pronto para testar</div>
  `);
  showVerdict();
}

function playSpeakerTest(earpiece) {
  const btn = document.getElementById('playBtn');
  const status = document.getElementById('playStatus');
  if (btn) btn.disabled = true;
  if (status) status.textContent = 'â–¶ Reproduzindo...';

  const ctx = getAudioCtx();

  // Play a pleasant two-tone melody
  const notes = [440, 550, 660, 550, 440];
  let time = ctx.currentTime;
  notes.forEach((freq, i) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = freq;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0, time + i * 0.2);
    gain.gain.linearRampToValueAtTime(0.4, time + i * 0.2 + 0.05);
    gain.gain.linearRampToValueAtTime(0, time + i * 0.2 + 0.18);
    osc.start(time + i * 0.2);
    osc.stop(time + i * 0.2 + 0.2);
  });

  setTimeout(() => {
    if (btn) btn.disabled = false;
    if (status) status.textContent = 'Som tocado! VocÃª ouviu pelo alto-falante?';
  }, 1200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: SPEAKER EAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function testSpeakerEar() {
  setDesc('Vamos tentar tocar um som pelo auricular (alto-falante de chamada). Coloque o celular no ouvido como se fosse uma ligaÃ§Ã£o e pressione Tocar.');

  const hasOutputAPI = !!(navigator.mediaDevices && navigator.mediaDevices.selectAudioOutput);

  setZone(`
    <div class="big-icon">ğŸ“</div>
    <button class="btn-action" id="earBtn" onclick="playEarpieceTest()">Tocar no Auricular</button>
    <div id="earStatus" style="font-size:12px;color:var(--muted);text-align:center;line-height:1.6">
      ${hasOutputAPI ? 'API de saÃ­da de Ã¡udio disponÃ­vel' : 'MÃ©todo alternativo (volume direto)'}
    </div>
  `);
  showVerdict();
}

async function playEarpieceTest() {
  const btn = document.getElementById('earBtn');
  const status = document.getElementById('earStatus');
  if (btn) btn.disabled = true;
  if (status) status.textContent = 'â–¶ Tentando rotear para auricular...';

  try {
    // Try Audio Output Devices API first
    if (navigator.mediaDevices && navigator.mediaDevices.selectAudioOutput) {
      const device = await navigator.mediaDevices.selectAudioOutput({ deviceId: 'default' });
      if (status) status.textContent = 'Dispositivo: ' + (device.label || 'auricular') + ' â€” tocando...';
    }
  } catch(e) {
    if (status) status.textContent = 'SeleÃ§Ã£o manual nÃ£o disponÃ­vel. Tocando e aguardando...';
  }

  // Play high frequency (more audible on earpiece)
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.frequency.value = 1000;
  osc.type = 'sine';
  gain.gain.setValueAtTime(0.5, ctx.currentTime);
  gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 1.5);
  osc.start(ctx.currentTime);
  osc.stop(ctx.currentTime + 1.5);

  setTimeout(() => {
    if (btn) btn.disabled = false;
    if (status) status.textContent = 'Coloque no ouvido! VocÃª ouviu pelo auricular?';
  }, 1600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: CAMERAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testCameras() {
  setDesc('Detectando cÃ¢meras disponÃ­veis...');
  setZone('<div class="spinner"></div>');

  try {
    // Get permissions first
    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
    tempStream.getTracks().forEach(t => t.stop());

    const devices = await navigator.mediaDevices.enumerateDevices();
    const cameras = devices.filter(d => d.kind === 'videoinput');
    deviceInfo.cameras = cameras;

    if (cameras.length === 0) {
      setZone('<p style="color:var(--fail)">Nenhuma cÃ¢mera detectada</p>');
      showVerdict();
      return;
    }

    setDesc(`<strong>${cameras.length} cÃ¢mera(s)</strong> detectada(s). Teste cada uma clicando no chip abaixo.`);

    const chips = cameras.map((cam, i) => {
      let label = cam.label || `CÃ¢mera ${i + 1}`;
      if (!cam.label) {
        if (i === 0) label = 'CÃ¢mera Principal (Traseira)';
        else if (i === 1) label = 'CÃ¢mera Frontal';
        else label = `CÃ¢mera Extra ${i}`;
      }
      return `<button class="cam-chip ${i===0?'active':''}" onclick="switchCamera('${cam.deviceId}', ${i})" id="camChip${i}">${label}</button>`;
    }).join('');

    setZone(`
      <div class="cam-list">${chips}</div>
      <video class="cam-preview" id="camPreview" autoplay playsinline muted></video>
      <div id="camLabel" style="font-size:11px;color:var(--muted)">Carregando cÃ¢mera...</div>
    `);

    switchCamera(cameras[0].deviceId, 0);
    showVerdict(`
      <div class="verdict-row">
        <button class="btn-pass" onclick="recordResult('pass', '${cameras.length} cÃ¢mera(s) testada(s)')">âœ… CÃ¢meras OK</button>
        <button class="btn-fail" onclick="recordResult('fail', 'cÃ¢mera com problema')">âŒ Problema</button>
      </div>
    `);
  } catch(e) {
    setZone(`<p style="color:var(--fail);font-size:13px">PermissÃ£o negada ou cÃ¢mera nÃ£o disponÃ­vel.<br><br>${e.message}</p>`);
    showVerdict(`
      <div class="verdict-row">
        <button class="btn-fail" onclick="recordResult('fail','PermissÃ£o negada')">âŒ NÃ£o Funcionou</button>
      </div>
    `);
  }
}

async function switchCamera(deviceId, idx) {
  stopStream();
  document.querySelectorAll('.cam-chip').forEach((el, i) => {
    el.classList.toggle('active', i === idx);
  });
  const label = document.getElementById('camLabel');
  if (label) label.textContent = 'Ativando cÃ¢mera...';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    activeStream = stream;
    const vid = document.getElementById('camPreview');
    if (vid) { vid.srcObject = stream; }
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings();
    if (label) label.textContent = `${settings.width}Ã—${settings.height} â€” ${track.label || 'ativa'}`;
  } catch(e) {
    if (label) label.textContent = 'Erro: ' + e.message;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: MICROPHONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testMicrophones() {
  setDesc('Detectando microfones...');
  setZone('<div class="spinner"></div>');

  try {
    const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    tempStream.getTracks().forEach(t => t.stop());

    const devices = await navigator.mediaDevices.enumerateDevices();
    const mics = devices.filter(d => d.kind === 'audioinput');
    deviceInfo.microphones = mics;

    setDesc(`<strong>${mics.length} microfone(s)</strong> detectado(s). Fale prÃ³ximo ao celular para ver o nÃ­vel de Ã¡udio.`);

    const chips = mics.map((mic, i) => {
      const label = mic.label || `Microfone ${i + 1}`;
      return `<button class="cam-chip ${i===0?'active':''}" onclick="switchMic('${mic.deviceId}',${i})">${label.substring(0,24)}</button>`;
    }).join('');

    setZone(`
      <div class="cam-list">${chips}</div>
      <canvas id="waveCanvas" class="waveform-canvas" width="400" height="80"></canvas>
      <div id="micLabel" style="font-size:11px;color:var(--muted)">Ativando microfone...</div>
    `);

    switchMic(mics[0].deviceId, 0);
    showVerdict(`
      <div class="verdict-row">
        <button class="btn-pass" onclick="recordResult('pass','${mics.length} microfone(s) testado(s)')">âœ… Microfones OK</button>
        <button class="btn-fail" onclick="recordResult('fail','microfone com problema')">âŒ Problema</button>
      </div>
    `);
  } catch(e) {
    setZone(`<p style="color:var(--fail);font-size:13px">PermissÃ£o negada: ${e.message}</p>`);
    showVerdict();
  }
}

async function switchMic(deviceId, idx) {
  stopStream();
  stopMic();
  document.querySelectorAll('.cam-chip').forEach((el, i) => el.classList.toggle('active', i === idx));
  const label = document.getElementById('micLabel');

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { deviceId: { exact: deviceId }, echoCancellation: false, noiseSuppression: false }
    });
    activeStream = stream;
    const track = stream.getAudioTracks()[0];
    if (label) label.textContent = track.label || 'Microfone ativo â€” fale agora';

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    micAnalyser = audioCtx.createAnalyser();
    micAnalyser.fftSize = 256;
    source.connect(micAnalyser);

    drawWaveform();
  } catch(e) {
    if (label) label.textContent = 'Erro: ' + e.message;
  }
}

function drawWaveform() {
  const canvas = document.getElementById('waveCanvas');
  if (!canvas || !micAnalyser) return;
  const ctx = canvas.getContext('2d');
  const bufferLen = micAnalyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLen);

  function draw() {
    micAnimFrame = requestAnimationFrame(draw);
    if (!micAnalyser || !document.getElementById('waveCanvas')) return;
    micAnalyser.getByteTimeDomainData(dataArray);

    const W = canvas.width, H = canvas.height;
    ctx.fillStyle = '#080c10';
    ctx.fillRect(0, 0, W, H);

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#00e5a0';
    ctx.beginPath();

    const sliceWidth = W / bufferLen;
    let x = 0;
    for (let i = 0; i < bufferLen; i++) {
      const v = dataArray[i] / 128.0;
      const y = (v * H) / 2;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
      x += sliceWidth;
    }
    ctx.lineTo(W, H / 2);
    ctx.stroke();
  }
  draw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: TOUCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function testTouch() {
  maxTouchPoints = 0;
  setDesc('Toque e arraste dentro da Ã¡rea abaixo. Use vÃ¡rios dedos ao mesmo tempo para testar multitouch.');
  setZone(`
    <canvas id="touchCanvas" width="400" height="220"></canvas>
    <div id="touchInfo" style="font-size:12px;color:var(--muted)">
      Toque mÃ¡ximo simultÃ¢neo: <strong id="touchMax">0</strong> dedos
      &nbsp;|&nbsp; Suporte declarado: <strong>${navigator.maxTouchPoints || 'N/A'}</strong>
    </div>
    <button class="btn-warn" onclick="clearTouchCanvas()" style="font-size:11px;padding:6px 14px">Limpar</button>
  `);

  setupTouchCanvas();
  showVerdict();
}

function setupTouchCanvas() {
  const canvas = document.getElementById('touchCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#0f1520';
  ctx.fillRect(0,0, canvas.width, canvas.height);
  ctx.strokeStyle = '#1e2d3d';
  ctx.setLineDash([4,8]);
  ctx.strokeRect(2,2, canvas.width-4, canvas.height-4);
  ctx.setLineDash([]);
  ctx.fillStyle = '#5a7a9a';
  ctx.font = '13px JetBrains Mono';
  ctx.textAlign = 'center';
  ctx.fillText('Toque aqui com vÃ¡rios dedos', canvas.width/2, canvas.height/2);

  const colors = ['#00e5a0','#00b4ff','#ffaa00','#ff3b5c','#a855f7','#f97316','#06b6d4','#84cc16','#ec4899','#f59e0b'];
  const activePointers = {};

  function onStart(e) {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const touches = e.changedTouches || [e];
    Array.from(touches).forEach(t => {
      const x = (t.clientX - rect.left) * scaleX;
      const y = (t.clientY - rect.top) * scaleY;
      activePointers[t.identifier ?? 0] = { x, y, color: colors[(Object.keys(activePointers).length) % colors.length] };
    });
    updateTouchCount();
  }

  function onMove(e) {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const touches = e.changedTouches || [e];
    Array.from(touches).forEach(t => {
      const x = (t.clientX - rect.left) * scaleX;
      const y = (t.clientY - rect.top) * scaleY;
      const prev = activePointers[t.identifier ?? 0];
      if (prev) {
        ctx.beginPath();
        ctx.strokeStyle = prev.color;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.moveTo(prev.x, prev.y);
        ctx.lineTo(x, y);
        ctx.stroke();
        activePointers[t.identifier ?? 0] = { x, y, color: prev.color };
      }
    });
  }

  function onEnd(e) {
    e.preventDefault();
    const touches = e.changedTouches || [e];
    Array.from(touches).forEach(t => { delete activePointers[t.identifier ?? 0]; });
  }

  function updateTouchCount() {
    const count = Object.keys(activePointers).length;
    if (count > maxTouchPoints) maxTouchPoints = count;
    const el = document.getElementById('touchMax');
    if (el) el.textContent = maxTouchPoints;
  }

  canvas.addEventListener('touchstart', onStart, { passive: false });
  canvas.addEventListener('touchmove', onMove, { passive: false });
  canvas.addEventListener('touchend', onEnd, { passive: false });
  canvas.addEventListener('touchcancel', onEnd, { passive: false });
  canvas.addEventListener('mousedown', onStart);
  canvas.addEventListener('mousemove', (e) => { if (e.buttons) onMove(e); });
  canvas.addEventListener('mouseup', onEnd);
}

function clearTouchCanvas() {
  const canvas = document.getElementById('touchCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#0f1520';
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: NETWORK / SIM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function testNetwork() {
  setDesc('Analisando conexÃ£o de rede e sinal. O browser nÃ£o acessa o sinal SIM diretamente, mas detecta o tipo e qualidade da conexÃ£o.');

  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  const online = navigator.onLine;

  let type = 'Desconhecido';
  let effectiveType = 'â€”';
  let downlink = 'â€”';
  let rtt = 'â€”';
  let simLikely = false;

  if (conn) {
    type = conn.type || 'desconhecido';
    effectiveType = conn.effectiveType || 'â€”';
    downlink = conn.downlink ? conn.downlink + ' Mbps' : 'â€”';
    rtt = conn.rtt ? conn.rtt + ' ms' : 'â€”';
    simLikely = type === 'cellular' || ['2g','3g','4g'].includes(effectiveType);
  }

  // Run speed test
  const speedStart = Date.now();
  const img = new Image();
  img.onload = () => {
    const elapsed = (Date.now() - speedStart) / 1000;
    const size = 1.1; // approx KB
    const speed = (size / elapsed * 8).toFixed(1);
    const el = document.getElementById('pingResult');
    if (el) el.textContent = elapsed < 1 ? `${Math.round(elapsed*1000)} ms latÃªncia` : `${elapsed.toFixed(2)}s â€” lento`;
  };
  img.onerror = () => {};
  img.src = 'https://www.google.com/favicon.ico?_=' + Date.now();

  const bars = [1,2,3,4,5].map((b,i) => {
    const active = simLikely && i < 4 ? 'active' : (online && !simLikely && i < 3 ? 'active' : '');
    return `<div class="signal-bar ${active}" style="height:${8+i*6}px"></div>`;
  }).join('');

  setZone(`
    <div class="signal-bars">${bars}</div>
    <div class="info-grid">
      <div class="info-card">
        <div class="info-card-label">Status</div>
        <div class="info-card-value" style="font-size:16px;color:${online?'var(--pass)':'var(--fail)'}">${online ? 'ğŸŸ¢ Online' : 'ğŸ”´ Offline'}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Tipo</div>
        <div class="info-card-value" style="font-size:14px">${type}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Qualidade</div>
        <div class="info-card-value" style="font-size:14px">${effectiveType.toUpperCase()}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Velocidade</div>
        <div class="info-card-value" style="font-size:14px">${downlink}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">LatÃªncia RTT</div>
        <div class="info-card-value" style="font-size:14px">${rtt}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Ping Real</div>
        <div class="info-card-value" style="font-size:14px" id="pingResult">Medindo...</div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--muted);text-align:center;line-height:1.7">
      âš ï¸ Sinal SIM em dBm nÃ£o Ã© acessÃ­vel via browser por restriÃ§Ãµes do sistema operacional.<br>
      ${simLikely ? 'âœ… ConexÃ£o celular detectada â€” SIM provavelmente presente' : ''}
    </div>
  `);

  showVerdict(`
    <div class="verdict-row">
      <button class="btn-pass" onclick="recordResult('pass','Tipo: ${type} / ${effectiveType} / ${downlink}')">âœ… Rede OK</button>
      <button class="btn-fail" onclick="recordResult('fail','Sem conexÃ£o ou sinal ruim')">âŒ Problema</button>
    </div>
  `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: WI-FI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function testWifi() {
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  const type = conn ? conn.type : null;
  const isWifi = type === 'wifi';
  const online = navigator.onLine;

  setDesc('Verificando conexÃ£o Wi-Fi. Certifique-se de que o Wi-Fi estÃ¡ ativado no celular.');
  setZone(`
    <div class="big-icon">ğŸ“¡</div>
    <div class="info-grid">
      <div class="info-card">
        <div class="info-card-label">Wi-Fi Detectado</div>
        <div class="info-card-value" style="color:${isWifi?'var(--pass)':'var(--warn)'}">${isWifi ? 'âœ… Sim' : 'âš ï¸ Incerto'}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Tipo Detectado</div>
        <div class="info-card-value" style="font-size:14px">${type || 'N/A'}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Internet</div>
        <div class="info-card-value" style="color:${online?'var(--pass)':'var(--fail)'};font-size:14px">${online?'Sim':'NÃ£o'}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Downlink</div>
        <div class="info-card-value" style="font-size:14px">${conn&&conn.downlink?conn.downlink+' Mbps':'N/A'}</div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--muted);text-align:center;line-height:1.7">
      Browsers nÃ£o acessam SSID/senha ou dBm do Wi-Fi por seguranÃ§a.<br>
      ${isWifi ? 'âœ… Confirmado: usando Wi-Fi' : 'Verifique se estÃ¡ no Wi-Fi nas configuraÃ§Ãµes do celular.'}
    </div>
  `);
  showVerdict(`
    <div class="verdict-row">
      <button class="btn-pass" onclick="recordResult('pass','Wi-Fi: ${isWifi?'detectado':'incerto via browser'}')">âœ… Wi-Fi OK</button>
      <button class="btn-fail" onclick="recordResult('fail','Wi-Fi desligado ou sem sinal')">âŒ Problema</button>
    </div>
  `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: BLUETOOTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testBluetooth() {
  setDesc('Vamos verificar o Bluetooth. O browser irÃ¡ abrir o seletor de dispositivos â€” se o BT estiver desligado, o sistema pedirÃ¡ para ativar.');

  const hasBT = 'bluetooth' in navigator;
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  if (isIOS) {
    setZone(`
      <div class="big-icon">ğŸ”µ</div>
      <div style="font-size:13px;color:var(--warn);text-align:center;line-height:1.7">
        âš ï¸ Safari/iOS nÃ£o suporta Web Bluetooth API.<br>
        Para testar Bluetooth em iOS, verifique nas configuraÃ§Ãµes do sistema.
      </div>
    `);
    showVerdict(`
      <div class="verdict-row">
        <button class="btn-pass" onclick="recordResult('warn','iOS â€” Web Bluetooth nÃ£o suportado')">âš ï¸ Pulei (iOS)</button>
        <button class="btn-fail" onclick="recordResult('fail','Bluetooth com problema')">âŒ Problema</button>
      </div>
    `);
    return;
  }

  if (!hasBT) {
    setZone(`<p style="color:var(--fail)">Web Bluetooth API nÃ£o disponÃ­vel neste browser.</p>`);
    showVerdict();
    return;
  }

  setZone(`
    <div class="big-icon">ğŸ”µ</div>
    <button class="btn-action" id="btBtn" onclick="scanBluetooth()">Escanear Dispositivos Bluetooth</button>
    <div id="btStatus" style="font-size:12px;color:var(--muted);text-align:center">Pronto â€” o seletor de BT irÃ¡ abrir</div>
  `);
  showVerdict();
}

async function scanBluetooth() {
  const btn = document.getElementById('btBtn');
  const status = document.getElementById('btStatus');
  if (btn) btn.disabled = true;
  if (status) status.textContent = 'Abrindo seletor de dispositivos...';

  try {
    const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
    if (status) status.innerHTML = `âœ… Dispositivo encontrado: <strong style="color:var(--accent)">${device.name || 'Desconhecido'}</strong><br>ID: ${device.id}`;
    results['bluetooth'] = { status: 'pass', detail: 'Dispositivo: ' + (device.name || device.id), label: 'Bluetooth', emoji: 'ğŸ”µ', category: 'Conectividade' };
  } catch(e) {
    if (e.name === 'NotFoundError') {
      if (status) status.textContent = 'Nenhum dispositivo selecionado (cancelado).';
    } else if (e.name === 'NotSupportedError') {
      if (status) status.textContent = 'Bluetooth desativado no dispositivo.';
    } else {
      if (status) status.textContent = e.message;
    }
  }
  if (btn) btn.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: FLASH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testFlash() {
  setDesc('Vamos ativar o flash (lanterna) da cÃ¢mera traseira. Pressione o botÃ£o abaixo.');
  setZone(`
    <div class="torch-zone" id="torchZone" onclick="toggleTorch()">ğŸ”¦</div>
    <div id="torchStatus" style="font-size:12px;color:var(--muted)">Clique para ligar/desligar o flash</div>
    <button class="btn-action" onclick="toggleTorch()" id="torchBtn">Ligar Flash</button>
  `);
  showVerdict();
}

async function toggleTorch() {
  const status = document.getElementById('torchStatus');
  const zone = document.getElementById('torchZone');
  const btn = document.getElementById('torchBtn');

  if (torchActive) {
    turnOffTorch();
    if (status) status.textContent = 'Flash desligado';
    if (zone) zone.classList.remove('on');
    if (btn) btn.textContent = 'Ligar Flash';
    return;
  }

  if (status) status.textContent = 'Ativando cÃ¢mera para flash...';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', advanced: [{ torch: true }] }
    });
    activeStream = stream;
    torchTrack = stream.getVideoTracks()[0];

    try {
      await torchTrack.applyConstraints({ advanced: [{ torch: true }] });
      torchActive = true;
      if (zone) zone.classList.add('on');
      if (status) status.textContent = 'âœ… Flash ligado! VocÃª viu o flash acender?';
      if (btn) btn.textContent = 'Desligar Flash';
    } catch(e2) {
      if (status) status.textContent = 'âš ï¸ Flash nÃ£o suportado neste device/browser: ' + e2.message;
    }
  } catch(e) {
    if (status) status.textContent = 'Erro: ' + e.message;
  }
}

function turnOffTorch() {
  if (torchTrack) {
    try { torchTrack.applyConstraints({ advanced: [{ torch: false }] }); } catch(e){}
  }
  torchActive = false;
  torchTrack = null;
  stopStream();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: FINGERPRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testFingerprint() {
  setDesc('Vamos testar o sensor biomÃ©trico (impressÃ£o digital) usando Web Authentication API. Pressione o botÃ£o e coloque o dedo no sensor.');

  const available = window.PublicKeyCredential && PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable;

  if (!available) {
    setZone('<p style="color:var(--fail)">WebAuthn nÃ£o disponÃ­vel neste browser.</p>');
    showVerdict();
    return;
  }

  setZone(`
    <div class="fingerprint-zone" id="fpZone">ğŸ”</div>
    <div id="fpStatus" style="font-size:13px;color:var(--muted);text-align:center;line-height:1.7">Verificando disponibilidade do sensor...</div>
    <button class="btn-action" id="fpBtn" onclick="doFingerprint()" disabled>Verificando...</button>
  `);

  try {
    const ok = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    const fpBtn = document.getElementById('fpBtn');
    const fpStatus = document.getElementById('fpStatus');

    if (ok) {
      if (fpBtn) { fpBtn.disabled = false; fpBtn.textContent = 'Escanear ImpressÃ£o Digital'; }
      if (fpStatus) fpStatus.textContent = 'Sensor biomÃ©trico detectado. Clique e coloque o dedo.';
    } else {
      if (fpBtn) { fpBtn.textContent = 'Sensor nÃ£o detectado'; }
      if (fpStatus) fpStatus.textContent = 'âš ï¸ Nenhum autenticador biomÃ©trico disponÃ­vel neste dispositivo.';
    }
  } catch(e) {
    const fpStatus = document.getElementById('fpStatus');
    if (fpStatus) fpStatus.textContent = 'Erro: ' + e.message;
  }

  showVerdict();
}

async function doFingerprint() {
  const zone = document.getElementById('fpZone');
  const status = document.getElementById('fpStatus');
  const btn = document.getElementById('fpBtn');
  if (btn) btn.disabled = true;
  if (zone) zone.className = 'fingerprint-zone scanning';
  if (status) status.textContent = 'Coloque o dedo no sensor...';

  try {
    const challenge = new Uint8Array(32);
    window.crypto.getRandomValues(challenge);

    const credential = await navigator.credentials.create({
      publicKey: {
        challenge,
        rp: { name: 'PhoneDiag', id: window.location.hostname || 'localhost' },
        user: { id: new Uint8Array(16), name: 'test@phonediag', displayName: 'Test User' },
        pubKeyCredParams: [{ alg: -7, type: 'public-key' }],
        authenticatorSelection: { authenticatorAttachment: 'platform', userVerification: 'required' },
        timeout: 30000,
      }
    });

    if (zone) zone.className = 'fingerprint-zone success';
    if (status) status.innerHTML = 'âœ… Biometria autenticada com sucesso!<br><span style="color:var(--muted);font-size:11px">Credential ID: ' + credential.id.substring(0,20) + '...</span>';
    results['fingerprint'] = { status: 'pass', detail: 'WebAuthn autenticado', label: 'ImpressÃ£o Digital', emoji: 'ğŸ”', category: 'SeguranÃ§a' };
  } catch(e) {
    if (zone) zone.className = 'fingerprint-zone error-fp';
    if (e.name === 'NotAllowedError') {
      if (status) status.textContent = 'Cancelado pelo usuÃ¡rio ou autenticaÃ§Ã£o falhou.';
    } else {
      if (status) status.textContent = 'Erro: ' + e.message;
    }
    if (btn) btn.disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: BATTERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testBattery() {
  setDesc('Verificando status da bateria e se estÃ¡ carregando.');

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  if (isIOS) {
    setZone(`
      <div class="big-icon">ğŸ”‹</div>
      <p style="color:var(--warn);font-size:13px;text-align:center;line-height:1.7">
        âš ï¸ Apple removeu a Battery Status API do Safari por privacidade.<br>
        Verifique o status da bateria na barra de status do iOS.
      </p>
    `);
    showVerdict(`
      <div class="verdict-row">
        <button class="btn-pass" onclick="recordResult('warn','iOS â€” Battery API nÃ£o disponÃ­vel')">âš ï¸ iOS (Aceitar)</button>
        <button class="btn-fail" onclick="recordResult('fail','Bateria com problema')">âŒ Problema</button>
      </div>
    `);
    return;
  }

  if (!navigator.getBattery) {
    setZone('<p style="color:var(--fail)">Battery Status API nÃ£o disponÃ­vel neste browser.</p>');
    showVerdict();
    return;
  }

  try {
    const battery = await navigator.getBattery();
    const pct = Math.round(battery.level * 100);
    const charging = battery.charging;
    const fillColor = pct > 50 ? '#00e5a0' : pct > 20 ? '#ffaa00' : '#ff3b5c';

    function updateBatUI() {
      const pctNow = Math.round(battery.level * 100);
      const chargingNow = battery.charging;
      const el = document.getElementById('batDisplay');
      if (el) el.innerHTML = buildBatHTML(pctNow, chargingNow);
    }

    battery.addEventListener('levelchange', updateBatUI);
    battery.addEventListener('chargingchange', updateBatUI);

    function buildBatHTML(p, c) {
      const fc = p > 50 ? '#00e5a0' : p > 20 ? '#ffaa00' : '#ff3b5c';
      return `
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
          <div class="battery-viz" style="color:${fc}">
            <div class="battery-fill" style="width:${p}%;background:${fc}"></div>
          </div>
          <div>
            <div style="font-size:32px;font-weight:700;color:${fc}">${p}%</div>
            <div style="font-size:11px;color:var(--muted)">${c ? 'âš¡ Carregando' : 'ğŸ”‹ Na bateria'}</div>
          </div>
        </div>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-card-label">Carregando</div>
            <div class="info-card-value" style="font-size:16px;color:${c?'var(--pass)':'var(--muted)'}">${c ? 'âœ… Sim' : 'NÃ£o'}</div>
          </div>
          <div class="info-card">
            <div class="info-card-label">Tempo restante</div>
            <div class="info-card-value" style="font-size:13px">
              ${c ? (battery.chargingTime !== Infinity ? Math.round(battery.chargingTime/60)+'min' : 'â€”') 
                  : (battery.dischargingTime !== Infinity ? Math.round(battery.dischargingTime/60)+'min' : 'â€”')}
            </div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:8px">
          ${c ? 'âœ… Carregamento detectado e funcionando' : 'Conecte o carregador e reconecte para testar'}
        </div>
      `;
    }

    setZone(`<div id="batDisplay">${buildBatHTML(pct, charging)}</div>`);
    showVerdict(`
      <div class="verdict-row">
        <button class="btn-pass" onclick="recordResult('pass','${pct}% ${charging?'carregando':'descarregando'}')">âœ… Bateria OK</button>
        <button class="btn-fail" onclick="recordResult('fail','problema na bateria/carregamento')">âŒ Problema</button>
      </div>
    `);
  } catch(e) {
    setZone(`<p style="color:var(--fail)">Erro: ${e.message}</p>`);
    showVerdict();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST: THERMAL / CPU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testThermal() {
  setDesc('Vamos estimar o estado tÃ©rmico/CPU. Usamos a Compute Pressure API (se disponÃ­vel) + estimativa via benchmark.');

  setZone(`
    <div class="big-icon">ğŸŒ¡ï¸</div>
    <button class="btn-action" onclick="runThermalTest()">Iniciar AnÃ¡lise TÃ©rmica</button>
    <div id="thermalStatus" style="font-size:12px;color:var(--muted);text-align:center">Pronto para iniciar</div>
  `);
  showVerdict();
}

async function runThermalTest() {
  const btn = document.querySelector('#testZone .btn-action');
  const status = document.getElementById('thermalStatus');
  if (btn) btn.disabled = true;
  if (status) status.textContent = 'âš™ï¸ Rodando benchmark (3 segundos)...';

  // 1. Try Compute Pressure API
  let pressureLevel = null;
  if ('PressureObserver' in window) {
    try {
      await new Promise((res) => {
        pressureObserver = new PressureObserver((records) => {
          pressureLevel = records[records.length - 1].state;
          res();
        }, { sampleInterval: 1000 });
        pressureObserver.observe('cpu');
        setTimeout(res, 3000);
      });
    } catch(e) {}
  }

  // 2. CPU Benchmark
  const start = performance.now();
  let ops = 0;
  const endTime = start + 3000;
  while (performance.now() < endTime) {
    Math.sqrt(Math.random() * 999999);
    ops++;
  }
  const elapsed = performance.now() - start;
  const opsPerSec = Math.round(ops / (elapsed / 1000));

  // 3. Battery drain estimation
  let batteryInfo = '';
  try {
    if (navigator.getBattery) {
      const bat = await navigator.getBattery();
      batteryInfo = bat.charging ? 'Conectado (carregando)' : `${Math.round(bat.level*100)}% â€” na bateria`;
    }
  } catch(e) {}

  // Estimate thermal state
  let thermalState = 'Normal';
  let thermalColor = 'var(--pass)';
  let thermalIcon = 'ğŸŸ¢';
  if (pressureLevel === 'serious' || pressureLevel === 'critical') {
    thermalState = pressureLevel === 'critical' ? 'CrÃ­tico âš ï¸' : 'Elevado âš ï¸';
    thermalColor = pressureLevel === 'critical' ? 'var(--fail)' : 'var(--warn)';
    thermalIcon = pressureLevel === 'critical' ? 'ğŸ”´' : 'ğŸŸ¡';
  } else if (opsPerSec < 2000000) {
    thermalState = 'PossÃ­vel throttling';
    thermalColor = 'var(--warn)';
    thermalIcon = 'ğŸŸ¡';
  }

  const zone = document.getElementById('testZone');
  if (!zone) return;
  zone.innerHTML = `
    <div style="font-size:36px">${thermalIcon}</div>
    <div class="info-grid">
      <div class="info-card">
        <div class="info-card-label">Estado TÃ©rmico</div>
        <div class="info-card-value" style="font-size:14px;color:${thermalColor}">${pressureLevel ? pressureLevel.toUpperCase() : thermalState}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Compute Pressure</div>
        <div class="info-card-value" style="font-size:14px">${pressureLevel || 'NÃ£o disponÃ­vel'}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Ops/s CPU</div>
        <div class="info-card-value" style="font-size:13px">${(opsPerSec/1000000).toFixed(1)}M</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Bateria</div>
        <div class="info-card-value" style="font-size:11px">${batteryInfo || 'N/A'}</div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--muted);text-align:center;line-height:1.7">
      Temperatura real do chip nÃ£o acessÃ­vel via browser.<br>
      AnÃ¡lise baseada em pressÃ£o de CPU e performance.
    </div>
  `;

  const detail = `Estado: ${pressureLevel || thermalState} / ${(opsPerSec/1000000).toFixed(1)}M ops/s`;
  const ta = document.getElementById('verdictArea');
  if (ta) ta.innerHTML = `
    <div class="verdict-row">
      <button class="btn-pass" onclick="recordResult('pass','${detail}')">âœ… CPU Normal</button>
      <button class="btn-fail" onclick="recordResult('fail','CPU com throttling ou aquecimento')">âŒ Aquecendo</button>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults() {
  showScreen('results');

  const all = Object.values(results);
  const passed = all.filter(r => r.status === 'pass').length;
  const failed = all.filter(r => r.status === 'fail').length;
  const skipped = all.filter(r => r.status === 'skip').length;
  const warned = all.filter(r => r.status === 'warn').length;
  const total = passed + failed + warned;
  const pct = total > 0 ? Math.round((passed / (passed + failed)) * 100) : 0;

  const scoreEl = document.getElementById('scoreDisplay');
  scoreEl.textContent = pct + '%';
  scoreEl.className = 'results-score ' + (pct >= 80 ? 'great' : pct >= 50 ? 'ok' : 'bad');

  document.getElementById('passCount').textContent = passed + warned;
  document.getElementById('failCount').textContent = failed;
  document.getElementById('skipCount').textContent = skipped;

  const list = document.getElementById('resultsList');
  list.innerHTML = '';

  const categories = [...new Set(all.map(r => r.category))];
  categories.forEach(cat => {
    const catResults = all.filter(r => r.category === cat);
    const heading = document.createElement('div');
    heading.className = 'results-section-title';
    heading.textContent = cat;
    list.appendChild(heading);

    catResults.forEach(r => {
      const statusMap = {
        pass: { icon: 'âœ…', cls: 'pass', badge: 'OK' },
        fail: { icon: 'âŒ', cls: 'fail', badge: 'FALHOU' },
        skip: { icon: 'â­', cls: 'skip', badge: 'PULADO' },
        warn: { icon: 'âš ï¸', cls: 'warn', badge: 'PARCIAL' },
      };
      const s = statusMap[r.status] || statusMap['skip'];

      const item = document.createElement('div');
      item.className = 'result-item';
      item.innerHTML = `
        <div class="result-icon ${s.cls}">${r.emoji}</div>
        <div class="result-info">
          <div class="result-name">${r.label}</div>
          <div class="result-detail">${r.detail || 'â€”'}</div>
        </div>
        <div class="result-badge ${s.cls}">${s.badge}</div>
      `;
      list.appendChild(item);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportReport() {
  const all = Object.values(results);
  const passed = all.filter(r => r.status === 'pass').length;
  const failed = all.filter(r => r.status === 'fail').length;
  const now = new Date().toLocaleString('pt-BR');

  let txt = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          PhoneDiag â€” RelatÃ³rio de DiagnÃ³stico          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Data/Hora: ${now}
Dispositivo: ${navigator.userAgent}
Plataforma: ${navigator.platform || 'N/A'}
CÃ¢meras detectadas: ${deviceInfo.cameras.length}
Microfones detectados: ${deviceInfo.microphones.length}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RESUMO: ${passed} OK | ${failed} Falhou | ${all.filter(r=>r.status==='skip').length} Pulado
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

RESULTADOS DETALHADOS:
`;

  all.forEach(r => {
    const icon = r.status === 'pass' ? 'âœ…' : r.status === 'fail' ? 'âŒ' : r.status === 'warn' ? 'âš ï¸' : 'â­';
    txt += `\n${icon} [${r.category}] ${r.label}\n   â†’ ${r.detail || 'Sem detalhes'}\n`;
  });

  txt += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nGerado por PhoneDiag â€” https://phonediag.netlify.app\n`;

  const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `phonediag_${Date.now()}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  toast('RelatÃ³rio exportado!');
}
</script>
</body>
</html>
